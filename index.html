<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>BLASTスイング記録｜新庄中野球部</title>

<!-- ✅ PWA設定 -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#009e60">
<link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="BLAST記録">

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js');
  });
}
</script>

<style>
/* =========================================================
   BLASTスイング記録｜iPad mini6対応・PWA安定完全CSS
   ========================================================= */

/* --- 全体リセット＆安全設定 --- */
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  max-width: 100%;
  font-family: "Noto Sans JP", sans-serif;
  background: #fff;
  color: #222;
  overscroll-behavior-x: none;
  -webkit-overflow-scrolling: touch;
  touch-action: pan-y;
  overflow-anchor: none; /* Safariの微振動防止 */
}

/* --- メインスクロール領域のみ制御 --- */
#viewport-lock {
  width: 100%;
  height: 100vh;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
}

/* --- メインエリア --- */
main {
  width: 94%;
  max-width: 800px;
  margin: 0 auto;
  padding: 15px 10px 60px;
}

/* --- タイトル --- */
h1 {
  text-align: center;
  color: #009e60;
  margin: 10px 0 20px;
  font-size: 1.4rem;
}

/* --- 入力欄エリア --- */
#metaBox {
  text-align: center;
  margin-bottom: 15px;
}
#metaBox input {
  padding: 6px 10px;
  margin: 4px;
  font-size: 0.9rem;
  border: 1px solid #ccc;
  border-radius: 4px;
}

/* --- テーブル構造 --- */
#blastTable {
  display: block;
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  border-collapse: separate !important;
  border-spacing: 0;
  margin: 0 auto 20px;
  table-layout: fixed;
}

table {
  width: 100%;
  border-spacing: 0;
  font-size: 0.9rem;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
  vertical-align: middle;
}

th {
  background: #e8f5e9;
  color: #006b4b;
  position: sticky;
  top: 0;
  z-index: 2;
  background-clip: padding-box;
}

/* --- コメント行 --- */
.comment-row td {
  background: #fafafa;
  font-size: 0.8rem;
  text-align: left;
  line-height: 1.6;
  padding: 6px 10px;
  border-top: none;
  color: #333;
}

/* --- テーブル列幅（全列均等） --- */
#blastTable th,
#blastTable td {
  width: 16.6%; /* 6列均等で100% */
}

/* --- 入力欄調整（セル幅にフィット） --- */
#blastTable input[type="text"],
#blastTable input[type="number"],
#blastTable select.grade {
  width: 90%;
  max-width: none;
  box-sizing: border-box;
  padding: 3px 5px;
  font-size: 0.8rem;
  border: 1px solid #ccc;
  border-radius: 3px;
}

/* --- ボタン --- */
button {
  background: #009e60;
  color: #fff;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  margin: 8px;
  transition: background 0.2s ease;
}
button:hover { background: #00784a; }

/* --- 平均値エリア --- */
#averageBox {
  text-align: center;
  margin-top: 15px;
  font-weight: bold;
  color: #006b4b;
  line-height: 1.8;
}

/* --- グラフ --- */
.chart-container {
  width: 100%;
  max-width: 700px;
  margin: 30px auto;
  position: relative;
}
canvas {
  width: 100% !important;
  height: auto !important;
  display: block;
}

/* --- レスポンシブ（スマホ対応） --- */
@media (max-width: 600px) {
  th, td { font-size: 0.8rem; padding: 4px; }
  button { padding: 6px 12px; font-size: 0.8rem; }
}
</style>
</head>

<body>
<div id="viewport-lock">
<main>
<h1>BLASTスイング記録</h1>

<div id="metaBox">
  <input type="text" id="teamName" value="新庄中野球部" placeholder="チーム名">
  <input type="date" id="recordDate">
</div>

<table id="blastTable">
  <thead>
    <tr>
      <th>学年</th>
      <th>氏名</th>
      <th>Bat Speed<br>(km/h)</th>
      <th>Attack Angle<br>(°)</th>
      <th>Time to Contact<br>(s)</th>
      <th>ヘッドスピード<br>※換算<br>(km/h)</th>
    </tr>
  </thead>
  <tbody id="tableBody">
    <tr>
      <td>
        <select class="grade">
          <option value="1年" selected>1年</option>
          <option value="2年">2年</option>
          <option value="3年">3年</option>
        </select>
      </td>
      <td><input type="text" value="石井"></td>
      <td><input type="number" step="0.1" class="batSpeed"></td>
      <td><input type="number" step="0.1" class="attackAngle"></td>
      <td><input type="number" step="0.001" class="timeContact"></td>
      <td class="refSpeed">-</td>
    </tr>
    <tr class="comment-row"><td colspan="6" class="comment">-</td></tr>
  </tbody>
</table>

<div style="text-align:center;">
  <button id="addRowBtn">＋ 選手を追加</button>
  <button id="removeRowBtn" style="background:#d62828;">− 選手を削除</button>
</div>

<div id="averageBox">
  <span id="avgAll">全体平均：-- km/h ｜ 参考：-- km/h</span><br>
  <span id="avg3">3年：-- km/h</span>　
  <span id="avg2">2年：-- km/h</span>　
  <span id="avg1">1年：-- km/h</span>
</div>

<div class="chart-container">
  <canvas id="barChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="scatterChart"></canvas>
</div>

<div style="text-align:center;">
  <button onclick="downloadCSV()">CSVダウンロード</button>
</div>
</main>
</div>

<script>
// === 初期設定 ===
document.getElementById("recordDate").valueAsDate = new Date();
const barCtx = document.getElementById("barChart").getContext("2d");
const scatterCtx = document.getElementById("scatterChart").getContext("2d");
const tableBody = document.getElementById("tableBody");

// === 学年反映 ===
function applyGradeToRow(row) {
  const select = row.querySelector(".grade");
  const commentRow = row.nextElementSibling;
  if (!select || !commentRow || !commentRow.classList.contains("comment-row")) return;
  const commentCell = commentRow.querySelector(".comment");
  const currentText = (commentCell.textContent || "").replace(/^【.*?】\s*/,"").trim() || "-";
  commentCell.textContent = `【${select.value}】 ${currentText}`;
}

window.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll("#tableBody tr:not(.comment-row)").forEach(applyGradeToRow);
});

document.addEventListener("change", e => {
  if (e.target.classList.contains("grade")) applyGradeToRow(e.target.closest("tr"));
});

// === PWA対応：選手追加・削除（iPad二重発火防止） ===
const addBtn = document.getElementById("addRowBtn");
const removeBtn = document.getElementById("removeRowBtn");

addBtn.addEventListener("click", e => {
  e.preventDefault();
  const newRow = document.createElement("tr");
  newRow.innerHTML = `
    <td><select class="grade">
      <option value="1年" selected>1年</option>
      <option value="2年">2年</option>
      <option value="3年">3年</option></select>
    </td>
    <td><input type="text"></td>
    <td><input type="number" step="0.1" class="batSpeed"></td>
    <td><input type="number" step="0.1" class="attackAngle"></td>
    <td><input type="number" step="0.001" class="timeContact"></td>
    <td class="refSpeed">-</td>`;
  const commentRow = document.createElement("tr");
  commentRow.className = "comment-row";
  commentRow.innerHTML = `<td colspan="6" class="comment">-</td>`;
  tableBody.appendChild(newRow);
  tableBody.appendChild(commentRow);
  applyGradeToRow(newRow);
});

removeBtn.addEventListener("click", e => {
  e.preventDefault();
  const rows = Array.from(document.querySelectorAll("#blastTable tbody tr"));
  if (rows.length < 2) return;
  const lastComment = rows.pop();
  const lastRow = rows.pop();
  if (lastRow && lastComment && lastComment.classList.contains("comment-row")) {
    lastRow.remove();
    lastComment.remove();
    updateAverages();
  }
});

// === 入力イベント ===
document.addEventListener("input", e => {
  if (e.target.matches(".batSpeed, .attackAngle, .timeContact")) {
    const row = e.target.closest("tr");
    updateRow(row);
    updateAverages();
  }
});

// === コメント評価 ===
function updateRow(row) {
  const batSpeed = parseFloat(row.querySelector(".batSpeed")?.value);
  const attack = parseFloat(row.querySelector(".attackAngle")?.value);
  const ttc = parseFloat(row.querySelector(".timeContact")?.value);
  const refCell = row.querySelector(".refSpeed");
  const commentRow = row.nextElementSibling?.classList.contains("comment-row") ? row.nextElementSibling : null;

  if (!isNaN(batSpeed)) refCell.textContent = (batSpeed * 1.08).toFixed(1);
  else refCell.textContent = "-";

  if (!isNaN(batSpeed) && !isNaN(attack) && commentRow)
    commentRow.querySelector(".comment").textContent = evaluate(batSpeed, attack, ttc);
  else if (commentRow) commentRow.querySelector(".comment").textContent = "-";
}

// === 評価ロジック ===
function evaluate(batSpeed, attack, ttc) {
  let hit = "", move = "", body = "", risk = "";

  // --- 打球傾向 ---
  if (attack < 0)
    hit = "バットがボールの上から入りゴロ傾向。押し込み不足。";
  else if (attack >= 0 && attack < 7)
    hit = "低角度スイングでゴロが多くなりやすい。";
  else if (attack >= 7 && attack <= 15)
    hit = "理想的な打球角度（7〜15°）。強いライナーが出やすい。";
  else if (attack > 15 && attack <= 22)
    hit = "やや上方向のスイングで高めの打球傾向。";
  else if (attack > 22)
    hit = "強いアッパー軌道でフライ・空振りが増えやすい。";

  // --- 動作傾向 ---
  if (batSpeed < 75 && attack < 7)
    move = "出力不足で下半身始動が遅れ、スイングが小さい。";
  else if (batSpeed < 75 && attack > 15)
    move = "上体主導で持ち上げる動き。胸郭の早開き傾向。";
  else if (batSpeed >= 75 && batSpeed < 85 && attack >= 7 && attack <= 15)
    move = "出力と角度の整合性が良い。安定したスイング。";
  else if (batSpeed >= 85 && attack > 15)
    move = "高出力だがアッパー傾向。胸郭が先行している。";
  else if (batSpeed >= 85 && attack >= 7 && attack <= 15)
    move = "強く、再現性の高いスイングゾーン。";

  // --- 反応 × タイミング ---
  if (!isNaN(ttc)) {
    if (attack >= 7 && attack <= 15 && ttc >= 0.17 && ttc <= 0.21)
      move += "タイミングも安定している。";
    else if (attack >= 7 && attack <= 15 && ttc > 0.22)
      move += "始動が遅れがち。差し込まれやすい。";
    else if (attack > 15 && ttc < 0.18)
      move += "始動が早すぎて溜め不足。前のめり気味。";
    else if (attack < 5 && ttc < 0.18)
      move += "突っ込み気味の下方向スイング。";
  }

  // --- フィジカル課題 ---
 // === フィジカル課題マッピング（修正版） ===
if (batSpeed < 75 && attack < 5)
  body = "股関節と下半身強化。股関節の受け止め方・地面反力系の取り組み推奨。";
else if (batSpeed >= 75 && batSpeed < 85 && ttc > 0.22)
  body = "軸安定と腹斜筋の動きを改善。骨盤先行と胸郭遅延の強化。";
else if (batSpeed >= 85 && attack > 15)
  body = "胸郭と肩甲骨の制御。捻転コントロール・胸郭連動系トレーニング。";
else if (batSpeed >= 80 && attack >= 7 && attack <= 15 && ttc < 0.21)
  body = "出力・角度・反応が整っており、全てのトレーニングで動きの再現性向上フェーズ。";

  // --- 意図的修正リスク ---
  if (attack < 7)
    risk = "ゴロ修正で角度を上げようとすると、上体が早く起きてフライが増える。押し出しを意識。";
  else if (attack > 15)
    risk = "フライ修正でスイングを浅くすると、力が前で切れる。押し込み位置を意識。";
  else
    risk = "好調時のスイングを変えると崩れる。リズム再現を優先。";

  return `
    <span class="type comment-type-hit">［打球傾向］${hit}</span>
    <span class="type comment-type-move">［動作傾向］${move}</span>
    <span class="type comment-type-body">［フィジカル課題］${body}</span>
    <span class="type comment-type-risk">［注意点］${risk}</span>
  `;
}

// === 平均計算 + グラフ描画 ===
function updateAverages() {
  const all = Array.from(document.querySelectorAll("tbody tr:not(.comment-row)"));
  const grades = { "1年": [], "2年": [], "3年": [] };
  const speeds = [];

  all.forEach(row => {
    const g = row.querySelector(".grade")?.value;
    const s = parseFloat(row.querySelector(".batSpeed")?.value);
    if (!isNaN(s)) {
      speeds.push(s);
      if (grades[g]) grades[g].push(s);
    }
  });

  const avg = speeds.length ? (speeds.reduce((a,b)=>a+b,0)/speeds.length).toFixed(1) : "--";
  const avgRef = avg !== "--" ? (avg * 1.08).toFixed(1) : "--";
  document.getElementById("avgAll").innerHTML = `全体平均：${avg} km/h ｜ 参考：${avgRef} km/h`;

  ["1年","2年","3年"].forEach(g => {
    const arr = grades[g];
    const mean = arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1) : "--";
    document.getElementById("avg" + g[0]).innerHTML = `${g}：${mean} km/h`;
  });

  drawBarChart(avg, grades);
  drawScatter(all);
}

// === 上段：棒グラフ ===
function drawBarChart(avgAll, grades) {
  adjustCanvasSize();
  barCtx.clearRect(0, 0, barCtx.canvas.width, barCtx.canvas.height);
  const data = [];
  if (avgAll !== "--") data.push({label:"全体", value:parseFloat(avgAll), color:"#009e60"});
  Object.entries(grades).forEach(([g, arr])=>{
    if (arr.length>0){
      const mean = (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1);
      data.push({label:g, value:parseFloat(mean), color:g==="3年"?"#d62828":g==="2年"?"#4c8":"#4ca3ff"});
    }
  });
  const barWidth = 60, gap = 50;
  data.forEach((d,i)=>{
    const x = 60 + i*(barWidth+gap);
    const height = (barCtx.canvas.height-40)*(d.value/100);
    barCtx.fillStyle=d.color;
    barCtx.fillRect(x, barCtx.canvas.height-height-20, barWidth, height);
    barCtx.fillStyle="#000"; barCtx.textAlign="center"; barCtx.font="12px sans-serif";
    barCtx.fillText(d.label, x+barWidth/2, barCtx.canvas.height-5);
    barCtx.fillText(d.value.toFixed(1), x+barWidth/2, barCtx.canvas.height-height-25);
  });
}

// === 下段：散布図 ===
function drawScatter(rows){
  adjustCanvasSize();
  scatterCtx.clearRect(0,0,scatterCtx.canvas.width,scatterCtx.canvas.height);
  const xMin=-10,xMax=30,yMin=50,yMax=110;
  const pad=40;
  scatterCtx.strokeStyle="#aaa";
  scatterCtx.strokeRect(pad,pad,scatterCtx.canvas.width-2*pad,scatterCtx.canvas.height-2*pad);
  scatterCtx.font="11px sans-serif"; scatterCtx.fillStyle="#000";
  scatterCtx.fillText("Attack Angle (°)", scatterCtx.canvas.width/2-30, scatterCtx.canvas.height-5);
  scatterCtx.save(); scatterCtx.translate(10,scatterCtx.canvas.height/2+20);
  scatterCtx.rotate(-Math.PI/2); scatterCtx.fillText("Bat Speed (km/h)",0,0); scatterCtx.restore();

  rows.forEach(row=>{
    const g=row.querySelector(".grade")?.value;
    const color=g==="3年"?"#d62828":g==="2年"?"#4c8":"#4ca3ff";
    const attack=parseFloat(row.querySelector(".attackAngle")?.value);
    const speed=parseFloat(row.querySelector(".batSpeed")?.value);
    if(isNaN(attack)||isNaN(speed)) return;
    const x=pad+(attack-xMin)/(xMax-xMin)*(scatterCtx.canvas.width-2*pad);
    const y=pad+(1-(speed-yMin)/(yMax-yMin))*(scatterCtx.canvas.height-2*pad);
    scatterCtx.beginPath();
    scatterCtx.arc(x,y,5,0,2*Math.PI);
    scatterCtx.fillStyle=color+"88";
    scatterCtx.fill();
  });
}

// === CSV出力 ===
function downloadCSV(){
  let csv="学年,氏名,BatSpeed,AttackAngle,TimeToContact,RefSpeed,コメント\n";
  document.querySelectorAll("#tableBody tr:not(.comment-row)").forEach(row=>{
    const grade=row.querySelector(".grade")?.value||"";
    const name=row.querySelector("input[type=text]")?.value||"";
    const s1=row.querySelector(".batSpeed")?.value||"";
    const s2=row.querySelector(".attackAngle")?.value||"";
    const s3=row.querySelector(".timeContact")?.value||"";
    const s4=row.querySelector(".refSpeed")?.textContent||"";
    const comment=row.nextElementSibling?.querySelector(".comment")?.textContent||"";
    csv+=`${grade},${name},${s1},${s2},${s3},${s4},"${comment}"\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="blast_record.csv";
  link.click();
}

// === サイズ調整 ===
function adjustCanvasSize() {
  const charts = document.querySelectorAll("canvas");
  charts.forEach(c => {
    const parentWidth = c.parentElement.offsetWidth;
    c.width = parentWidth;
    c.height = parentWidth * 0.6;
  });
}
window.addEventListener('load', adjustCanvasSize);
window.addEventListener('resize', adjustCanvasSize);
</script>
</body>
</html>
