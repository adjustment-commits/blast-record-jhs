<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>BLASTã‚¹ã‚¤ãƒ³ã‚°è¨˜éŒ²ï½œæ–°åº„ä¸­é‡çƒéƒ¨</title>

<!-- âœ… PWAè¨­å®š -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#009e60">
<link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="BLASTè¨˜éŒ²">

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js');
  });
}
</script>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  font-family: "Noto Sans JP", sans-serif;
  background: #fff;
  color: #222;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior-x: none;
}

#viewport-lock {
  width: 100%;
  height: 100vh;
  overflow-y: auto;
  overflow-x: hidden;
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
}

main {
  width: 100%;
  max-width: 800px;
  margin: 0 auto;
  padding: 15px 10px 60px;
  overflow-x: hidden;
}

h1 {
  text-align: center;
  color: #009e60;
  margin: 10px 0 20px;
  font-size: 1.4rem;
}

#metaBox {
  text-align: center;
  margin-bottom: 15px;
}
#metaBox input {
  padding: 6px 10px;
  margin: 4px;
  font-size: 0.9rem;
  border: 1px solid #ccc;
  border-radius: 4px;
}

#blastTable {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
  margin: 0 auto;
}

/* å„åˆ—å¹… */
#blastTable th:nth-child(1),
#blastTable td:nth-child(1) { width: 10%; } /* å­¦å¹´ */
#blastTable th:nth-child(2),
#blastTable td:nth-child(2) { width: 18%; } /* æ°å */
#blastTable th:nth-child(3),
#blastTable td:nth-child(3),
#blastTable th:nth-child(4),
#blastTable td:nth-child(4),
#blastTable th:nth-child(5),
#blastTable td:nth-child(5),
#blastTable th:nth-child(6),
#blastTable td:nth-child(6) { width: 17%; }

/* è¡¨å…¨ä½“ */
th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
  vertical-align: middle;
  word-break: keep-all;
  white-space: normal;
}

/* è¦‹å‡ºã— */
th {
  background: #e8f5e9;
  color: #006b4b;
  position: sticky;
  top: 0;
  z-index: 2;
  font-size: 0.8rem;
  line-height: 1.3;
  word-break: break-word;
}

/* å…¥åŠ›æ¬„èª¿æ•´ */
#blastTable select,
#blastTable input {
  width: 95%;
  font-size: 0.8rem;
  padding: 4px;
  box-sizing: border-box;
}

/* æ°åã ã‘å·¦å¯„ã›ã« */
#blastTable td:nth-child(2) input {
  text-align: left;
  padding-left: 6px;
}

.comment-row td {
  background: #fafafa;
  font-size: 0.8rem;
  text-align: left;
  line-height: 1.7;
  padding: 6px 10px;
  border-top: none;
  color: #333;
  white-space: normal;       /* â†ã“ã‚Œã‚’è¿½åŠ ï¼ */
  word-break: break-word;    /* â†ã“ã‚Œã‚‚è¿½åŠ ï¼ */
}

/* ã‚³ãƒ¡ãƒ³ãƒˆåˆ†é¡ãƒ‡ã‚¶ã‚¤ãƒ³ */
.comment-row .type {
  display: block;
  margin-bottom: 4px;
}
.comment-type-hit { color: #00695c; font-weight: bold; }
.comment-type-move { color: #1b5e20; }
.comment-type-body { color: #33691e; font-weight: bold; }
.comment-type-risk { color: #c62828; font-weight: bold; }

button {
  background: #009e60;
  color: #fff;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  margin: 8px;
  transition: background 0.2s ease;
}
button:hover { background: #00784a; }

#averageBox {
  text-align: center;
  margin-top: 15px;
  font-weight: bold;
  color: #006b4b;
  line-height: 1.8;
}

.chart-container {
  width: 100%;
  max-width: 700px;
  margin: 30px auto;
  position: relative;
}
canvas {
  width: 100% !important;
  height: auto !important;
  display: block;
}

@media (max-width: 600px) {
  th, td { font-size: 0.8rem; padding: 4px; }
  button { padding: 6px 12px; font-size: 0.8rem; }
}
</style>
</head>

<body>
<div id="viewport-lock">
<main>
<h1>BLASTã‚¹ã‚¤ãƒ³ã‚°è¨˜éŒ²</h1>

<div id="metaBox">
  <input type="text" id="teamName" value="æ–°åº„ä¸­é‡çƒéƒ¨" placeholder="ãƒãƒ¼ãƒ å">
  <input type="date" id="recordDate">
</div>

<table id="blastTable">
  <thead>
    <tr>
      <th>å­¦å¹´</th>
      <th>æ°å</th>
      <th>Bat Speed<br>(km/h)</th>
      <th>Attack Angle<br>(Â°)</th>
      <th>Time to Contact<br>(s)</th>
      <th>ãƒ˜ãƒƒãƒ‰ã‚¹ãƒ”ãƒ¼ãƒ‰<br>â€»æ›ç®—<br>(km/h)</th>
    </tr>
  </thead>
  <tbody id="tableBody">
    <tr>
      <td>
        <select class="grade">
          <option value="1å¹´" selected>1å¹´</option>
          <option value="2å¹´">2å¹´</option>
          <option value="3å¹´">3å¹´</option>
        </select>
      </td>
      <td><input type="text" value="çŸ³äº•"></td>
      <td><input type="number" step="0.1" class="batSpeed"></td>
      <td><input type="number" step="0.1" class="attackAngle"></td>
      <td><input type="number" step="0.001" class="timeContact"></td>
      <td class="refSpeed">-</td>
    </tr>
    <tr class="comment-row"><td colspan="6" class="comment">-</td></tr>
  </tbody>
</table>

<div style="text-align:center;">
  <button id="addRowBtn">ï¼‹ é¸æ‰‹ã‚’è¿½åŠ </button>
  <button id="removeRowBtn" style="background:#d62828;">âˆ’ é¸æ‰‹ã‚’å‰Šé™¤</button>
</div>

<div style="text-align:center; margin-top:10px;">
  <button onclick="saveData()" style="background:#006b4b;">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ä¿å­˜</button>
  <button onclick="loadData()" style="background:#4c8;">ğŸ“‚ ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ</button>
  <button onclick="resetData()" style="background:#d62828;">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
</div>

<div id="averageBox">
  <span id="avgAll">å…¨ä½“å¹³å‡ï¼š-- km/h ï½œ å‚è€ƒï¼š-- km/h</span><br>
  <span id="avg3">3å¹´ï¼š-- km/h</span>ã€€
  <span id="avg2">2å¹´ï¼š-- km/h</span>ã€€
  <span id="avg1">1å¹´ï¼š-- km/h</span>
</div>

<div class="chart-container">
  <canvas id="barChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="scatterChart"></canvas>
</div>

<div style="text-align:center;">
  <button onclick="downloadCSV()">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
</div>
</main>
</div>

<script>
// === åˆæœŸè¨­å®š ===
document.getElementById("recordDate").valueAsDate = new Date();
const barCtx = document.getElementById("barChart").getContext("2d");
const scatterCtx = document.getElementById("scatterChart").getContext("2d");
const tableBody = document.getElementById("tableBody");

// === å­¦å¹´åæ˜  ===
function applyGradeToRow(row) {
  const select = row.querySelector(".grade");
  const commentRow = row.nextElementSibling;
  if (!select || !commentRow || !commentRow.classList.contains("comment-row")) return;
  const commentCell = commentRow.querySelector(".comment");
  const currentText = (commentCell.textContent || "").replace(/^ã€.*?ã€‘\s*/,"").trim() || "-";
  commentCell.textContent = `ã€${select.value}ã€‘ ${currentText}`;
}

window.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll("#tableBody tr:not(.comment-row)").forEach(applyGradeToRow);
});

document.addEventListener("change", e => {
  if (e.target.classList.contains("grade")) applyGradeToRow(e.target.closest("tr"));
});

// === PWAå¯¾å¿œï¼šé¸æ‰‹è¿½åŠ ãƒ»å‰Šé™¤ ===
const addBtn = document.getElementById("addRowBtn");
const removeBtn = document.getElementById("removeRowBtn");

addBtn.addEventListener("click", e => {
  e.preventDefault();
  const newRow = document.createElement("tr");
  newRow.innerHTML = `
    <td><select class="grade">
      <option value="1å¹´" selected>1å¹´</option>
      <option value="2å¹´">2å¹´</option>
      <option value="3å¹´">3å¹´</option></select>
    </td>
    <td><input type="text"></td>
    <td><input type="number" step="0.1" class="batSpeed"></td>
    <td><input type="number" step="0.1" class="attackAngle"></td>
    <td><input type="number" step="0.001" class="timeContact"></td>
    <td class="refSpeed">-</td>`;
  const commentRow = document.createElement("tr");
  commentRow.className = "comment-row";
  commentRow.innerHTML = `<td colspan="6" class="comment">-</td>`;
  tableBody.appendChild(newRow);
  tableBody.appendChild(commentRow);
  applyGradeToRow(newRow);
});

removeBtn.addEventListener("click", e => {
  e.preventDefault();
  const rows = Array.from(document.querySelectorAll("#blastTable tbody tr"));
  if (rows.length < 2) return;
  const lastComment = rows.pop();
  const lastRow = rows.pop();
  if (lastRow && lastComment && lastComment.classList.contains("comment-row")) {
    lastRow.remove();
    lastComment.remove();
    updateAverages();
  }
});

// === å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ ===
document.addEventListener("input", e => {
  if (e.target.matches(".batSpeed, .attackAngle, .timeContact")) {
    const row = e.target.closest("tr");
    updateRow(row);
    updateAverages();
  }
});

// === ã‚³ãƒ¡ãƒ³ãƒˆè©•ä¾¡ ===
function updateRow(row) {
  const batSpeed = parseFloat(row.querySelector(".batSpeed")?.value);
  const attack = parseFloat(row.querySelector(".attackAngle")?.value);
  const ttc = parseFloat(row.querySelector(".timeContact")?.value);
  const refCell = row.querySelector(".refSpeed");
  const commentRow = row.nextElementSibling?.classList.contains("comment-row") ? row.nextElementSibling : null;

  if (!isNaN(batSpeed)) refCell.textContent = (batSpeed * 1.08).toFixed(1);
  else refCell.textContent = "-";

  if (!isNaN(batSpeed) && !isNaN(attack) && commentRow)
    commentRow.querySelector(".comment").innerHTML = evaluate(batSpeed, attack, ttc);
  else if (commentRow) commentRow.querySelector(".comment").textContent = "-";
}

// === è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯ ===
function evaluate(batSpeed, attack, ttc) {
  let hit = "", move = "", body = "", risk = "";

  // --- æ‰“çƒå‚¾å‘ ---
  if (attack < 0)
    hit = "ãƒãƒƒãƒˆãŒãƒœãƒ¼ãƒ«ã®ä¸Šã‹ã‚‰å…¥ã‚Šã‚´ãƒ­å‚¾å‘ã€‚æŠ¼ã—è¾¼ã¿ä¸è¶³ã€‚";
  else if (attack >= 0 && attack < 7)
    hit = "ä½è§’åº¦ã‚¹ã‚¤ãƒ³ã‚°ã§ã‚´ãƒ­å‚¾å‘ã€‚è§’åº¦ã¯æ§ãˆã‚ã€‚";
  else if (attack >= 7 && attack <= 15)
    hit = "ç†æƒ³çš„ãªæ‰“çƒè§’åº¦ï¼ˆ7ã€œ15Â°ï¼‰ã€‚åŠ›å¼·ã„ãƒ©ã‚¤ãƒŠãƒ¼ãŒå‡ºã‚„ã™ã„ã€‚";
  else if (attack > 15 && attack <= 22)
    hit = "ä¸Šæ–¹å‘ã®ã‚¹ã‚¤ãƒ³ã‚°ã§é«˜ã‚ã®æ‰“çƒå‚¾å‘ã€‚";
  else if (attack > 22)
    hit = "ã‚¢ãƒƒãƒ‘ãƒ¼å‚¾å‘ã€‚æ‰“çƒãŒä¸ŠãŒã‚Šã™ãã‚„ã™ã„ã€‚";
  else
    hit = "ã‚¹ã‚¤ãƒ³ã‚°è§’åº¦ã®ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã€‚æ‰“çƒæ–¹å‘ã®å†ç¢ºèªãŒå¿…è¦ã€‚";

  // --- å‹•ä½œå‚¾å‘ ---
  if (isNaN(batSpeed) || isNaN(attack)) {
    move = "ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã€‚æ¬¡å›æ¸¬å®šã§å†ç¢ºèªã€‚";
  } else if (batSpeed < 70) {
    move = "å‡ºåŠ›ãŒä¸è¶³ã€‚åŠ›ã‚’å‡ºã—åˆ‡ã‚Œã¦ã„ãªã„ã€‚ä¸‹åŠèº«å§‹å‹•ãŒé…ã‚ŒãŒã¡ã€‚";
  } else if (batSpeed >= 70 && batSpeed < 80) {
    if (attack < 7) move = "ä¸‹åŠèº«ã®æŠ¼ã—è¾¼ã¿å¼±ãã€ã‚¹ã‚¤ãƒ³ã‚°ãŒæµ…ã„ã€‚";
    else if (attack > 15) move = "ä¸Šä½“ä¸»å°ã€‚æŒã¡ä¸Šã’ã‚‹å‹•ããŒå¼·ã„ã€‚";
    else move = "å‡ºåŠ›ã¨è§’åº¦ãŒæ•´ã„ã¤ã¤ã‚ã‚‹ã€‚å†ç¾æ€§ã‚’é«˜ã‚ãŸã„æ®µéšã€‚";
  } else if (batSpeed >= 80 && batSpeed < 90) {
    if (attack < 5) move = "åŠ›æ„Ÿã¯ã‚ã‚‹ãŒæ–¹å‘æ€§ãŒå®‰å®šã—ãªã„ã€‚æŠ¼ã—è¾¼ã¿ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ä¿®æ­£ã€‚";
    else if (attack > 18) move = "å¼·ã„å‡ºåŠ›ã ãŒã€ä¸Šæ–¹å‘ã¸ã®é€ƒã’ãŒã‚ã‚‹ã€‚èƒ¸éƒ­ãŒå…ˆè¡Œã€‚";
    else move = "å‡ºåŠ›ã¨è§’åº¦ã®æ•´åˆæ€§ãŒé«˜ã„ã€‚å®Ÿæˆ¦ã§ã‚‚çµæœã‚’å‡ºã›ã‚‹ã‚¹ã‚¤ãƒ³ã‚°ã‚¾ãƒ¼ãƒ³ã€‚";
  } else if (batSpeed >= 90) {
    if (attack < 7) move = "é«˜å‡ºåŠ›ã ãŒè§’åº¦ãŒä½ãã€å·®ã—è¾¼ã¾ã‚Œã‚„ã™ã„ã€‚";
    else if (attack > 18) move = "å‡ºåŠ›å…ˆè¡Œã§ã‚„ã‚„åŠ›ã¿æ°—å‘³ã€‚è»¸ãƒãƒ©ãƒ³ã‚¹ã‚’å†ç¢ºèªã€‚";
    else move = "å¼·ãã€å®‰å®šæ€§ã®ã‚ã‚‹ç†æƒ³çš„ãªã‚¹ã‚¤ãƒ³ã‚°ã€‚";
  }

  // --- åå¿œ Ã— ã‚¿ã‚¤ãƒŸãƒ³ã‚° ---
if (!isNaN(ttc)) {
  // ğŸ†• 0.16ç§’ä»¥ä¸‹ï¼šåå¿œç‰¹æ€§ã‚³ãƒ¡ãƒ³ãƒˆ
  if (ttc < 0.16) {
    move += "åå¿œé€Ÿåº¦ãŒéå¸¸ã«é€Ÿãã€çƒã¸ã®å…¥ã‚ŠãŒæ—©ã„ã‚¿ã‚¤ãƒ—ã€‚åˆå‹•ã®é‹­ã•ãŒæ­¦å™¨ã€‚";
    body += "é«˜åå¿œå‹ã€‚å‹•ãå‡ºã—ãŒæ—©ã„ã¶ã‚“ã€é–“ã‚’å–ã‚‹ç·´ç¿’ã‚„ãƒˆãƒƒãƒ—ä¿æŒã§å†ç¾æ€§ã‚’é«˜ã‚ãŸã„ã€‚";
  }

  if (attack >= 7 && attack <= 15 && ttc >= 0.17 && ttc <= 0.21)
    move += "ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚‚å®‰å®šã—ã¦ã„ã‚‹ã€‚";
  else if (attack >= 7 && attack <= 15 && ttc > 0.22)
    move += "å§‹å‹•ãŒé…ã‚ŒãŒã¡ã€‚å·®ã—è¾¼ã¾ã‚Œã‚„ã™ã„ã€‚";
  else if (attack > 15 && ttc < 0.18)
    move += "å§‹å‹•ãŒæ—©ã™ãã¦æºœã‚ä¸è¶³ã€‚å‰ã®ã‚ã‚Šæ°—å‘³ã€‚";
  else if (attack < 5 && ttc < 0.18)
    move += "çªã£è¾¼ã¿æ°—å‘³ã®ä¸‹æ–¹å‘ã‚¹ã‚¤ãƒ³ã‚°ã€‚";
}
  // --- ãƒ•ã‚£ã‚¸ã‚«ãƒ«èª²é¡Œ ---
  if (isNaN(batSpeed)) {
    body = "ãƒ‡ãƒ¼ã‚¿æœªå…¥åŠ›ã€‚ç­‹å‡ºåŠ›ãƒ»å®‰å®šæ€§ã®ç¢ºèªãŒå¿…è¦ã€‚";
  } else if (batSpeed < 75) {
    body = "ä¸‹åŠèº«ã¨è‚¡é–¢ç¯€ã®å‡ºåŠ›ä¸è¶³ã€‚åœ°é¢ååŠ›ç³»ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ¨å¥¨ã€‚";
  } else if (batSpeed >= 75 && batSpeed < 85) {
    if (ttc > 0.22)
      body = "è…¹æ–œç­‹ã¨ä½“å¹¹ã®å®‰å®šå¼·åŒ–ã€‚éª¨ç›¤å…ˆè¡Œã¨èƒ¸éƒ­é…å»¶ã‚’æ„è­˜ã€‚";
    else
      body = "å‡ºåŠ›ã¯å®‰å®šã€‚å‹•ä½œé€£å‹•ã‚’é«˜ã‚ãŸã„æ®µéšã€‚";
  } else if (batSpeed >= 85 && attack > 15) {
    body = "èƒ¸éƒ­ã¨è‚©ç”²éª¨ã®åˆ¶å¾¡ãŒèª²é¡Œã€‚æ»è»¢å·®ã¨èƒ¸éƒ­é€£å‹•ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’æ¨å¥¨ã€‚";
  } else {
    body = "å…¨ä½“ã®ãƒãƒ©ãƒ³ã‚¹è‰¯å¥½ã€‚åå¿œé€Ÿåº¦ã¨å†ç¾æ€§ã®å‘ä¸Šãƒ•ã‚§ãƒ¼ã‚ºã€‚";
  }

 // --- æ„å›³çš„ä¿®æ­£ãƒªã‚¹ã‚¯ ---
if (attack < 7)
  risk = "ã‚´ãƒ­ä¿®æ­£ã§è§’åº¦ã‚’ä¸Šã’ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ä¸Šä½“ãŒæ—©ãèµ·ãã¦ãƒ•ãƒ©ã‚¤ãŒå¢—ãˆã‚‹ã€‚æŠ¼ã—å‡ºã—ã‚’æ„è­˜ã€‚";
else if (attack > 15)
  risk = "ãƒ•ãƒ©ã‚¤ä¿®æ­£ã§ã‚¹ã‚¤ãƒ³ã‚°ã‚’æµ…ãã™ã‚‹ã¨ã€åŠ›ãŒå‰ã§åˆ‡ã‚Œã‚‹ã€‚æŠ¼ã—è¾¼ã¿ä½ç½®ã‚’æ„è­˜ã€‚";
else if (batSpeed >= 80 && attack >= 7 && attack <= 15)
  risk = "è¨ˆæ¸¬ä¸Šã¯ç†æƒ³ã ãŒã€å®Ÿæˆ¦ã§ã¯ã€åˆ¤æ–­â†’å§‹å‹•ã€ã®é…ã‚Œã§å·®ã—è¾¼ã¾ã‚Œã‚‹å‚¾å‘ã€‚åå¿œã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’æ„è­˜ã€‚";
else
  risk = "ãƒªã‚ºãƒ ã‚„é–“ã®ä¹±ã‚Œã§ä¸€æ°—ã«å´©ã‚Œã‚‹ã€‚å¥½èª¿æ™‚ã®å†ç¾ãƒªã‚ºãƒ ã‚’å„ªå…ˆã€‚";

// --- è¿½åŠ æ¡ä»¶ï¼šTTCé…ã‚Œã«ã‚ˆã‚‹ãƒªã‚¹ã‚¯è£œè¶³ ---
if (!isNaN(ttc) && ttc > 0.19) {
  risk += " å§‹å‹•ãŒé…ã‚ŒãŒã¡ã§ã€å·®ã—è¾¼ã¾ã‚Œã‚‹ãƒªã‚¹ã‚¯ãŒé«˜ã„ã€‚æ‰“ã¡å‡ºã—ã®æº–å‚™ã‚’æ—©ã‚ãŸã„ã€‚";
}
  return `
    <span class="type comment-type-hit">ï¼»æ‰“çƒå‚¾å‘ï¼½${hit}</span>
    <span class="type comment-type-move">ï¼»å‹•ä½œå‚¾å‘ï¼½${move}</span>
    <span class="type comment-type-body">ï¼»ãƒ•ã‚£ã‚¸ã‚«ãƒ«èª²é¡Œï¼½${body}</span>
    <span class="type comment-type-risk">ï¼»æ³¨æ„ç‚¹ï¼½${risk}</span>
  `;
}

// === å¹³å‡è¨ˆç®— + ã‚°ãƒ©ãƒ•æç”» ===
function updateAverages() {
  const all = Array.from(document.querySelectorAll("tbody tr:not(.comment-row)"));
  const grades = { "1å¹´": [], "2å¹´": [], "3å¹´": [] };
  const speeds = [];

  all.forEach(row => {
    const g = row.querySelector(".grade")?.value;
    const s = parseFloat(row.querySelector(".batSpeed")?.value);
    if (!isNaN(s)) {
      speeds.push(s);
      if (grades[g]) grades[g].push(s);
    }
  });

  const avg = speeds.length ? (speeds.reduce((a,b)=>a+b,0)/speeds.length).toFixed(1) : "--";
  const avgRef = avg !== "--" ? (avg * 1.08).toFixed(1) : "--";
  document.getElementById("avgAll").innerHTML = `å…¨ä½“å¹³å‡ï¼š${avg} km/h ï½œ å‚è€ƒï¼š${avgRef} km/h`;

  ["1å¹´","2å¹´","3å¹´"].forEach(g => {
    const arr = grades[g];
    const mean = arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1) : "--";
    document.getElementById("avg" + g[0]).innerHTML = `${g}ï¼š${mean} km/h`;
  });

  drawBarChart(avg, grades);
  drawScatter(all);
}

// === ä¸Šæ®µï¼šæ£’ã‚°ãƒ©ãƒ• ===
function drawBarChart(avgAll, grades) {
  adjustCanvasSize();
  barCtx.clearRect(0, 0, barCtx.canvas.width, barCtx.canvas.height);
  const data = [];
  if (avgAll !== "--") data.push({label:"å…¨ä½“", value:parseFloat(avgAll), color:"#009e60"});
  Object.entries(grades).forEach(([g, arr])=>{
    if (arr.length>0){
      const mean = (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1);
      data.push({label:g, value:parseFloat(mean), color:g==="3å¹´"?"#d62828":g==="2å¹´"?"#4c8":"#4ca3ff"});
    }
  });
  const barWidth = 60, gap = 50;
  data.forEach((d,i)=>{
    const x = 60 + i*(barWidth+gap);
    const height = (barCtx.canvas.height-40)*(d.value/100);
    barCtx.fillStyle=d.color;
    barCtx.fillRect(x, barCtx.canvas.height-height-20, barWidth, height);
    barCtx.fillStyle="#000"; barCtx.textAlign="center"; barCtx.font="12px sans-serif";
    barCtx.fillText(d.label, x+barWidth/2, barCtx.canvas.height-5);
    barCtx.fillText(d.value.toFixed(1), x+barWidth/2, barCtx.canvas.height-height-25);
  });
}

// === ä¸‹æ®µï¼šæ•£å¸ƒå›³ ===
function drawScatter(rows){
  adjustCanvasSize();
  scatterCtx.clearRect(0,0,scatterCtx.canvas.width,scatterCtx.canvas.height);
  const xMin=-10,xMax=30,yMin=50,yMax=110;
  const pad=40;
  scatterCtx.strokeStyle="#aaa";
  scatterCtx.strokeRect(pad,pad,scatterCtx.canvas.width-2*pad,scatterCtx.canvas.height-2*pad);
  scatterCtx.font="11px sans-serif"; scatterCtx.fillStyle="#000";
  scatterCtx.fillText("Attack Angle (Â°)", scatterCtx.canvas.width/2-30, scatterCtx.canvas.height-5);
  scatterCtx.save(); scatterCtx.translate(10,scatterCtx.canvas.height/2+20);
  scatterCtx.rotate(-Math.PI/2); scatterCtx.fillText("Bat Speed (km/h)",0,0); scatterCtx.restore();

  rows.forEach(row=>{
    const g=row.querySelector(".grade")?.value;
    const color=g==="3å¹´"?"#d62828":g==="2å¹´"?"#4c8":"#4ca3ff";
    const attack=parseFloat(row.querySelector(".attackAngle")?.value);
    const speed=parseFloat(row.querySelector(".batSpeed")?.value);
    if(isNaN(attack)||isNaN(speed)) return;
    const x=pad+(attack-xMin)/(xMax-xMin)*(scatterCtx.canvas.width-2*pad);
    const y=pad+(1-(speed-yMin)/(yMax-yMin))*(scatterCtx.canvas.height-2*pad);
    scatterCtx.beginPath();
    scatterCtx.arc(x,y,5,0,2*Math.PI);
    scatterCtx.fillStyle=color+"88";
    scatterCtx.fill();
  });
}

// === CSVå‡ºåŠ› ===
function downloadCSV(){
  let csv="å­¦å¹´,æ°å,BatSpeed,AttackAngle,TimeToContact,RefSpeed,ã‚³ãƒ¡ãƒ³ãƒˆ\n";
  document.querySelectorAll("#tableBody tr:not(.comment-row)").forEach(row=>{
    const grade=row.querySelector(".grade")?.value||"";
    const name=row.querySelector("input[type=text]")?.value||"";
    const s1=row.querySelector(".batSpeed")?.value||"";
    const s2=row.querySelector(".attackAngle")?.value||"";
    const s3=row.querySelector(".timeContact")?.value||"";
    const s4=row.querySelector(".refSpeed")?.textContent||"";
    const comment=row.nextElementSibling?.querySelector(".comment")?.innerText||"";
    csv+=`${grade},${name},${s1},${s2},${s3},${s4},"${comment}"\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="blast_record.csv";
  link.click();
}
  
// === æ‰‹å‹•ä¿å­˜ãƒ»å¾©å…ƒãƒ»ãƒªã‚»ãƒƒãƒˆï¼ˆJSONç‰ˆï¼‰ ===
function saveData() {
  const rows = Array.from(document.querySelectorAll("#tableBody tr:not(.comment-row)"));
  const data = rows.map(row => ({
    grade: row.querySelector(".grade")?.value || "",
    name: row.querySelector("input[type=text]")?.value || "",
    batSpeed: parseFloat(row.querySelector(".batSpeed")?.value) || null,
    attackAngle: parseFloat(row.querySelector(".attackAngle")?.value) || null,
    timeContact: parseFloat(row.querySelector(".timeContact")?.value) || null
  }));
  localStorage.setItem("blastRecords", JSON.stringify(data));
  alert("ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
}

function loadData() {
  const saved = localStorage.getItem("blastRecords");
  if (!saved) return alert("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");

  const data = JSON.parse(saved);
  tableBody.innerHTML = ""; // åˆæœŸåŒ–

  data.forEach(d => {
    const newRow = document.createElement("tr");
    newRow.innerHTML = `
      <td><select class="grade">
        <option value="1å¹´" ${d.grade==="1å¹´"?"selected":""}>1å¹´</option>
        <option value="2å¹´" ${d.grade==="2å¹´"?"selected":""}>2å¹´</option>
        <option value="3å¹´" ${d.grade==="3å¹´"?"selected":""}>3å¹´</option>
      </select></td>
      <td><input type="text" value="${d.name || ""}"></td>
      <td><input type="number" step="0.1" class="batSpeed" value="${d.batSpeed || ""}"></td>
      <td><input type="number" step="0.1" class="attackAngle" value="${d.attackAngle || ""}"></td>
      <td><input type="number" step="0.001" class="timeContact" value="${d.timeContact || ""}"></td>
      <td class="refSpeed">-</td>`;
    const commentRow = document.createElement("tr");
    commentRow.className = "comment-row";
    commentRow.innerHTML = `<td colspan="6" class="comment">-</td>`;
    tableBody.appendChild(newRow);
    tableBody.appendChild(commentRow);

    // è©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆã‚’å†ç”Ÿæˆ
    updateRow(newRow);
  });

  alert("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸã€‚");
  updateAverages();
  window.scrollTo(0, 0);
}

function resetData() {
  if (confirm("ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
    localStorage.removeItem("blastRecords");
    location.reload();
  }
}
  
// === ã‚µã‚¤ã‚ºèª¿æ•´ ===
function adjustCanvasSize() {
  const charts = document.querySelectorAll("canvas");
  charts.forEach(c => {
    const parentWidth = c.parentElement.offsetWidth;
    c.width = parentWidth;
    c.height = parentWidth * 0.6;
  });
}
window.addEventListener('load', adjustCanvasSize);
window.addEventListener('resize', adjustCanvasSize);
</script>

</body>
</html>
